import React, { useState, useEffect, useRef, useCallback }from 'react';
import { initializeApp } from 'firebase/app';
import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    signInAnonymously,
    signInWithCustomToken
} from 'firebase/auth';
import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    addDoc,
    collection,
    query,
    where,
    getDocs,
    updateDoc,
    deleteDoc,
    onSnapshot,
    serverTimestamp
} from 'firebase/firestore';
import * as Tone from 'tone'; // لاستخدام المؤثرات الصوتية

// --- أيقونات SVG بسيطة ---
const UserIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
        <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
    </svg>
);

const LockClosedIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
        <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
    </svg>
);

const ShoppingBagIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 text-red-500">
        <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
    </svg>
);

const PlusCircleIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
      <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
    </svg>
);

const TrashIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
        <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.56 0c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
    </svg>
);

const PencilIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
        <path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
    </svg>
);

// --- تهيئة Firebase ---
// !! هام: استبدل هذا بكائن تهيئة Firebase الخاص بك !!
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "AIzaSyA8jEsfD3QmfzIUEnUWLD96hSHNE67Z1ac", // استبدل هذا
    authDomain: "hany.iceiy.com", // استبدل هذا
    projectId: "
hany-salh", // استبدل هذا
    storageBucket: "YOUR_STORAGE_BUCKET", // استبدل هذا
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // استبدل هذا
    appId: "1:402997456916:web:a0491f61bf7bc2c9bc7701" // استبدل هذا
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'abu-al-ezz-store'; // معرف التطبيق

// --- المؤثرات الصوتية ---
let synth;
try {
    synth = new Tone.Synth().toDestination();
} catch (error) {
    console.error("Tone.js synth could not be initialized:", error);
    synth = null; // Fallback if Tone.js fails (e.g., in restricted environments)
}

const playClickSound = () => {
    if (synth && Tone.context.state !== 'running') {
        Tone.start().then(() => {
            if (synth) synth.triggerAttackRelease("C5", "8n");
        }).catch(e => console.warn("Tone.start() failed:", e));
    } else if (synth) {
        synth.triggerAttackRelease("C5", "8n");
    }
};

// --- مكونات الواجهة ---

// شريط التنقل
const Navbar = ({ user, onLogout, onPageChange, isAdmin, userData }) => {
    const handleInteraction = (action) => {
        playClickSound();
        action();
    };

    return (
        <nav className="bg-black p-4 shadow-lg sticky top-0 z-50">
            <div className="container mx-auto flex justify-between items-center">
                <div className="flex items-center space-x-2 cursor-pointer" onClick={() => handleInteraction(() => onPageChange('home'))}>
                    <ShoppingBagIcon />
                    <h1 className="text-2xl font-bold text-red-500">متجر ابو العز</h1>
                </div>
                <div className="space-x-4 flex items-center">
                    <button onClick={() => handleInteraction(() => onPageChange('home'))} className="text-gray-300 hover:text-red-400 transition duration-300">الرئيسية</button>
                    {isAdmin && (
                        <button onClick={() => handleInteraction(() => onPageChange('admin'))} className="text-gray-300 hover:text-red-400 transition duration-300">لوحة التحكم</button>
                    )}
                    {user ? (
                        <>
                            <div className="text-gray-300">
                                {userData?.username && <span>مرحباً, {userData.username} | </span>}
                                الرصيد: {userData?.balance?.toFixed(2) || '0.00'} {userData?.currency || 'USD'}
                            </div>
                            <button onClick={() => handleInteraction(() => onPageChange('profile'))} className="text-gray-300 hover:text-red-400 transition duration-300">الملف الشخصي</button>
                            <button onClick={() => handleInteraction(onLogout)} className="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">تسجيل الخروج</button>
                        </>
                    ) : (
                        <button onClick={() => handleInteraction(() => onPageChange('login'))} className="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">تسجيل الدخول</button>
                    )}
                </div>
            </div>
        </nav>
    );
};

// صفحة تسجيل الدخول / التسجيل
const AuthPage = ({ onLoginSuccess, onPageChange }) => {
    const [isLogin, setIsLogin] = useState(true);
    const [email, setEmail] = useState(''); // استخدام البريد الإلكتروني لتسجيل الدخول الأساسي في Firebase
    const [password, setPassword] = useState('');
    const [username, setUsername] = useState('');
    const [phoneNumber, setPhoneNumber] = useState('');
    const [country, setCountry] = useState('العراق');
    const [governorate, setGovernorate] = useState('');
    const [postalCode, setPostalCode] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        playClickSound();

        // التحقق من أن البريد الإلكتروني وكلمة المرور ليسا فارغين
        if (!email.trim() || !password.trim()) {
            setError("البريد الإلكتروني وكلمة المرور مطلوبان.");
            setLoading(false);
            return;
        }
        // التحقق من صحة البريد الإلكتروني
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            setError("الرجاء إدخال عنوان بريد إلكتروني صالح.");
            setLoading(false);
            return;
        }


        try {
            if (isLogin) {
                await signInWithEmailAndPassword(auth, email, password);
                onLoginSuccess();
            } else {
                // التحقق من الحقول الإضافية عند التسجيل
                if (!username.trim() || !phoneNumber.trim() || !country.trim() || !governorate.trim() || !postalCode.trim()) {
                    setError("يرجى ملء جميع حقول التسجيل.");
                    setLoading(false);
                    return;
                }
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                // حفظ بيانات المستخدم الإضافية في Firestore
                const userDocPath = `/artifacts/${appId}/users/${user.uid}`;
                await setDoc(doc(db, userDocPath), {
                    uid: user.uid,
                    email: user.email,
                    username: username,
                    phoneNumber: phoneNumber,
                    country: country,
                    governorate: governorate,
                    postalCode: postalCode,
                    balance: 0,
                    currency: 'USD', // عملة افتراضية
                    language: 'ar', // لغة افتراضية
                    isAdmin: (username === 'hany' && password === 'hany11'), // تعيين المشرف هنا بشكل مبدئي
                    createdAt: serverTimestamp()
                });
                onLoginSuccess();
            }
        } catch (err) {
            console.error("Authentication error:", err);
            setError(err.message === "Firebase: Error (auth/invalid-credential)." ? "بيانات الاعتماد غير صحيحة. يرجى التحقق من البريد الإلكتروني وكلمة المرور." : "حدث خطأ. يرجى المحاولة مرة أخرى. " + err.code);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 via-black to-gray-800 p-4">
            <div className="bg-gray-800 p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-500 hover:scale-105">
                <h2 className="text-3xl font-bold text-center text-red-500 mb-8 animate-pulse">
                    {isLogin ? 'تسجيل الدخول إلى ابو العز' : 'إنشاء حساب جديد'}
                </h2>
                {error && <p className="bg-red-700 text-white p-3 rounded-md mb-6 text-center">{error}</p>}
                <form onSubmit={handleSubmit} className="space-y-6">
                    {!isLogin && (
                        <>
                            <InputField label="اسم المستخدم" type="text" value={username} onChange={(e) => setUsername(e.target.value)} icon={<UserIcon />} placeholder="مثال: hany" />
                            <InputField label="رقم الهاتف" type="tel" value={phoneNumber} onChange={(e) => setPhoneNumber(e.target.value)} icon={<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.018-.991-.053-1.464l-.093-.811a18.75 18.75 0 0 0-5.384-5.384l-.811-.093c-.473-.035-.948-.053-1.464-.053H6.75A2.25 2.25 0 0 0 4.5 8.25v2.25Z" /></svg>} placeholder="مثال: 07701234567" />
                        </>
                    )}
                    <InputField label="البريد الإلكتروني" type="email" value={email} onChange={(e) => setEmail(e.target.value)} icon={<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" /></svg>} placeholder="example@email.com" />
                    <InputField label="كلمة المرور" type="password" value={password} onChange={(e) => setPassword(e.target.value)} icon={<LockClosedIcon />} placeholder="********" />
                    {!isLogin && (
                        <>
                            <InputField label="الدولة" type="text" value={country} onChange={(e) => setCountry(e.target.value)} icon={<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>} placeholder="مثال: العراق" />
                            <InputField label="المحافظة" type="text" value={governorate} onChange={(e) => setGovernorate(e.target.value)} icon={<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M9 6.75V15m6-6v8.25m.503-6.998a4.5 4.5 0 0 1-8.006.498M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>} placeholder="مثال: بغداد" />
                            <InputField label="الرمز البريدي" type="text" value={postalCode} onChange={(e) => setPostalCode(e.target.value)} icon={<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 0 1-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5v-1.875a3.375 3.375 0 0 1 3.375-3.375h1.5a1.125 1.125 0 0 1 1.125 1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375m17.25 4.5Z" /></svg>} placeholder="مثال: 10011" />
                        </>
                    )}
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 disabled:opacity-50"
                    >
                        {loading ? 'جاري المعالجة...' : (isLogin ? 'تسجيل الدخول' : 'إنشاء حساب')}
                    </button>
                </form>
                <p className="mt-8 text-center text-gray-400">
                    {isLogin ? 'ليس لديك حساب؟' : 'هل لديك حساب بالفعل؟'}
                    <button onClick={() => { playClickSound(); setIsLogin(!isLogin); setError(''); }} className="text-red-400 hover:text-red-300 font-semibold ml-2 transition duration-300">
                        {isLogin ? 'إنشاء حساب جديد' : 'تسجيل الدخول'}
                    </button>
                </p>
            </div>
        </div>
    );
};

const InputField = ({ label, type, value, onChange, icon, placeholder }) => (
    <div>
        <label className="block text-sm font-medium text-gray-300 mb-1">{label}</label>
        <div className="relative">
            <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                {icon}
            </span>
            <input
                type={type}
                value={value}
                onChange={onChange}
                placeholder={placeholder}
                required
                className="w-full pl-10 pr-3 py-2.5 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-300 shadow-sm focus:shadow-md"
            />
        </div>
    </div>
);


// الصفحة الرئيسية
const HomePage = ({ onPageChange, user, isAdmin, userData }) => {
    const [products, setProducts] = useState([]);
    const [ads, setAds] = useState([]);
    const [loadingProducts, setLoadingProducts] = useState(true);
    const [loadingAds, setLoadingAds] = useState(true);

    useEffect(() => {
        // جلب المنتجات
        const productsPath = `/artifacts/${appId}/public/data/products`;
        const qProducts = query(collection(db, productsPath));
        const unsubscribeProducts = onSnapshot(qProducts, (querySnapshot) => {
            const productsData = [];
            querySnapshot.forEach((doc) => {
                productsData.push({ id: doc.id, ...doc.data() });
            });
            setProducts(productsData);
            setLoadingProducts(false);
        }, (error) => {
            console.error("Error fetching products: ", error);
            setLoadingProducts(false);
        });

        // جلب الإعلانات النشطة
        const adsPath = `/artifacts/${appId}/public/data/advertisements`;
        const qAds = query(collection(db, adsPath), where("isActive", "==", true));
        const unsubscribeAds = onSnapshot(qAds, (querySnapshot) => {
            const adsData = [];
            querySnapshot.forEach((doc) => {
                adsData.push({ id: doc.id, ...doc.data() });
            });
            setAds(adsData);
            setLoadingAds(false);
        }, (error) => {
            console.error("Error fetching ads: ", error);
            setLoadingAds(false);
        });
        
        return () => {
            unsubscribeProducts();
            unsubscribeAds();
        };
    }, []);

    const handleProductClick = (productId) => {
        playClickSound();
        // يمكن هنا الانتقال لصفحة تفاصيل المنتج إذا أردت
        console.log("Product clicked:", productId);
    };
    
    const handleAdClick = (ad) => {
        playClickSound();
        if (ad.linkUrl) {
            window.open(ad.linkUrl, '_blank');
        }
    };

    return (
        <div className="bg-gray-900 min-h-screen p-4 md:p-8 text-white">
            {/* قسم الإعلانات */}
            {loadingAds && <p className="text-center my-4">جاري تحميل الإعلانات...</p>}
            {!loadingAds && ads.length > 0 && (
                <section className="mb-12">
                    <h2 className="text-3xl font-bold text-red-500 mb-6 text-center">أحدث الإعلانات</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {ads.map(ad => (
                            <div key={ad.id} 
                                 className="bg-gray-800 rounded-lg shadow-xl overflow-hidden transform transition-all duration-300 hover:scale-105 cursor-pointer"
                                 onClick={() => handleAdClick(ad)}>
                                <img 
                                    src={ad.imageUrl || `https://placehold.co/600x300/1a202c/ef4444?text=${encodeURIComponent(ad.title || 'إعلان')}`} 
                                    alt={ad.title || 'إعلان'} 
                                    className="w-full h-48 object-cover"
                                    onError={(e) => e.target.src = `https://placehold.co/600x300/1a202c/ef4444?text=${encodeURIComponent(ad.title || 'صورة غير متوفرة')}`}
                                />
                                <div className="p-4">
                                    <h3 className="text-xl font-semibold text-red-400">{ad.title || 'إعلان مميز'}</h3>
                                </div>
                            </div>
                        ))}
                    </div>
                </section>
            )}

            {/* قسم المنتجات */}
            <section>
                <h2 className="text-3xl font-bold text-red-500 mb-6 text-center">منتجاتنا</h2>
                {loadingProducts && <p className="text-center my-4">جاري تحميل المنتجات...</p>}
                {!loadingProducts && products.length === 0 && <p className="text-center my-4">لا توجد منتجات لعرضها حالياً.</p>}
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    {products.map(product => (
                        <ProductCard key={product.id} product={product} onClick={() => handleProductClick(product.id)} />
                    ))}
                </div>
            </section>
        </div>
    );
};

// بطاقة المنتج
const ProductCard = ({ product, onClick }) => {
    const averageRating = product.rating && product.rating.count > 0 
        ? (product.rating.sum / product.rating.count).toFixed(1) 
        : "N/A";

    return (
        <div 
            onClick={onClick}
            className="bg-gray-800 rounded-lg shadow-xl overflow-hidden transform transition-all duration-500 hover:shadow-red-500/50 hover:scale-105 cursor-pointer flex flex-col justify-between"
        >
            <img 
                src={product.imageUrl || `https://placehold.co/400x300/1a202c/ef4444?text=${encodeURIComponent(product.name || 'منتج')}`} 
                alt={product.name} 
                className="w-full h-56 object-cover"
                onError={(e) => e.target.src = `https://placehold.co/400x300/1a202c/ef4444?text=${encodeURIComponent(product.name || 'صورة غير متوفرة')}`}
            />
            <div className="p-5 flex-grow">
                <h3 className="text-xl font-semibold text-red-400 mb-2 truncate">{product.name}</h3>
                <p className="text-gray-400 text-sm mb-3 h-16 overflow-hidden">{product.description}</p>
            </div>
            <div className="p-5 border-t border-gray-700">
                <div className="flex justify-between items-center mb-3">
                    <p className="text-2xl font-bold text-red-500">{product.price} {product.currency || 'USD'}</p>
                    <div className="flex items-center">
                        <span className="text-yellow-400 mr-1">⭐</span>
                        <span className="text-gray-300">{averageRating} ({product.rating?.count || 0})</span>
                    </div>
                </div>
                <button className="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                    أضف إلى السلة
                </button>
            </div>
        </div>
    );
};

// صفحة الملف الشخصي
const ProfilePage = ({ user, userData, onPageChange, onUpdateUserData }) => {
    const [balanceToAdd, setBalanceToAdd] = useState('');
    const [message, setMessage] = useState('');
    const [loading, setLoading] = useState(false);

    const handleAddBalance = async (e) => {
        e.preventDefault();
        playClickSound();
        const amount = parseFloat(balanceToAdd);
        if (isNaN(amount) || amount <= 0) {
            setMessage('الرجاء إدخال مبلغ صحيح.');
            return;
        }
        setLoading(true);
        setMessage('');

        try {
            const newBalance = (userData.balance || 0) + amount;
            const userDocRef = doc(db, `/artifacts/${appId}/users/${user.uid}`);
            await updateDoc(userDocRef, { balance: newBalance });
            onUpdateUserData({ ...userData, balance: newBalance }); // تحديث الحالة المحلية
            setMessage(`تم شحن رصيدك بمبلغ ${amount.toFixed(2)} ${userData.currency || 'USD'} بنجاح.`);
            setBalanceToAdd('');
        } catch (error) {
            console.error("Error adding balance: ", error);
            setMessage('حدث خطأ أثناء شحن الرصيد.');
        } finally {
            setLoading(false);
        }
    };
    
    if (!userData) return <div className="text-center p-10 text-white">جاري تحميل بيانات الملف الشخصي...</div>;

    return (
        <div className="min-h-screen bg-gray-900 p-4 md:p-8 text-white">
            <div className="container mx-auto max-w-2xl bg-gray-800 rounded-xl shadow-2xl p-6 md:p-10">
                <h2 className="text-3xl font-bold text-red-500 mb-8 text-center">الملف الشخصي</h2>
                
                <div className="space-y-4 mb-8">
                    <InfoItem label="اسم المستخدم" value={userData.username} />
                    <InfoItem label="البريد الإلكتروني" value={userData.email} />
                    <InfoItem label="رقم الهاتف" value={userData.phoneNumber} />
                    <InfoItem label="الدولة" value={userData.country} />
                    <InfoItem label="المحافظة" value={userData.governorate} />
                    <InfoItem label="الرمز البريدي" value={userData.postalCode} />
                    <InfoItem label="الرصيد الحالي" value={`${(userData.balance || 0).toFixed(2)} ${userData.currency || 'USD'}`} className="text-red-400 font-bold" />
                    <InfoItem label="اللغة" value={userData.language === 'ar' ? 'العربية' : userData.language} />
                </div>

                <div className="border-t border-gray-700 pt-8">
                    <h3 className="text-2xl font-semibold text-red-500 mb-6">شحن الرصيد</h3>
                    {message && <p className={`p-3 rounded-md mb-4 ${message.includes('بنجاح') ? 'bg-green-600' : 'bg-red-700'} text-white`}>{message}</p>}
                    <form onSubmit={handleAddBalance} className="space-y-4">
                        <div>
                            <label htmlFor="balanceAmount" className="block text-sm font-medium text-gray-300 mb-1">المبلغ المراد شحنه ({userData.currency || 'USD'})</label>
                            <input
                                type="number"
                                id="balanceAmount"
                                value={balanceToAdd}
                                onChange={(e) => setBalanceToAdd(e.target.value)}
                                placeholder="مثال: 50"
                                step="0.01"
                                className="w-full p-2.5 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:ring-red-500 focus:border-red-500"
                                required
                            />
                        </div>
                        <button 
                            type="submit"
                            disabled={loading}
                            className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 disabled:opacity-50"
                        >
                            {loading ? 'جاري الشحن...' : 'شحن الرصيد الآن'}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    );
};

const InfoItem = ({ label, value, className = '' }) => (
    <div className="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
        <span className="text-gray-400">{label}:</span>
        <span className={`text-gray-100 font-medium ${className}`}>{value || 'غير متوفر'}</span>
    </div>
);

// لوحة تحكم المشرف
const AdminPage = ({ user }) => {
    const [activeTab, setActiveTab] = useState('products'); // products, ads, settings
    const [products, setProducts] = useState([]);
    const [ads, setAds] = useState([]);
    // Product form state
    const [productForm, setProductForm] = useState({ id: null, name: '', description: '', price: '', imageUrl: '', currency: 'USD' });
    // Ad form state
    const [adForm, setAdForm] = useState({ id: null, title: '', imageUrl: '', linkUrl: '', isActive: true });
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState('');

    const userId = auth.currentUser?.uid; // For createdBy field

    // Fetch products
    useEffect(() => {
        if (activeTab === 'products') {
            const productsPath = `/artifacts/${appId}/public/data/products`;
            const unsubscribe = onSnapshot(collection(db, productsPath), (snapshot) => {
                const fetchedProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setProducts(fetchedProducts);
            });
            return () => unsubscribe();
        }
    }, [activeTab]);

    // Fetch ads
    useEffect(() => {
        if (activeTab === 'ads') {
            const adsPath = `/artifacts/${appId}/public/data/advertisements`;
            const unsubscribe = onSnapshot(collection(db, adsPath), (snapshot) => {
                const fetchedAds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setAds(fetchedAds);
            });
            return () => unsubscribe();
        }
    }, [activeTab]);

    const handleProductSubmit = async (e) => {
        e.preventDefault();
        playClickSound();
        if (!productForm.name || !productForm.description || !productForm.price) {
            setMessage({ type: 'error', text: 'يرجى ملء جميع حقول المنتج المطلوبة.' });
            return;
        }
        setLoading(true);
        setMessage('');
        try {
            const productsPath = `/artifacts/${appId}/public/data/products`;
            const productData = { 
                ...productForm, 
                price: parseFloat(productForm.price),
                rating: productForm.id ? productForm.rating : { sum: 0, count: 0 }, // Keep existing rating on edit
                createdBy: userId,
                updatedAt: serverTimestamp()
            };
            if (!productForm.id) { // If new product
                productData.createdAt = serverTimestamp();
            }

            if (productForm.id) { // Edit existing product
                await setDoc(doc(db, productsPath, productForm.id), productData, { merge: true });
                setMessage({ type: 'success', text: 'تم تحديث المنتج بنجاح!' });
            } else { // Add new product
                await addDoc(collection(db, productsPath), productData);
                setMessage({ type: 'success', text: 'تم إضافة المنتج بنجاح!' });
            }
            setProductForm({ id: null, name: '', description: '', price: '', imageUrl: '', currency: 'USD' });
        } catch (error) {
            console.error("Error saving product:", error);
            setMessage({ type: 'error', text: 'خطأ في حفظ المنتج: ' + error.message });
        } finally {
            setLoading(false);
        }
    };
    
    const handleEditProduct = (product) => {
        playClickSound();
        setProductForm({ ...product, price: product.price.toString() }); // Convert price to string for input
    };

    const handleDeleteProduct = async (productId) => {
        playClickSound();
        if (window.confirm('هل أنت متأكد أنك تريد حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء.')) {
            setLoading(true);
            try {
                const productDocPath = `/artifacts/${appId}/public/data/products/${productId}`;
                await deleteDoc(doc(db, productDocPath));
                setMessage({ type: 'success', text: 'تم حذف المنتج بنجاح.' });
            } catch (error) {
                console.error("Error deleting product:", error);
                setMessage({ type: 'error', text: 'خطأ في حذف المنتج: ' + error.message });
            } finally {
                setLoading(false);
            }
        }
    };

    const handleAdSubmit = async (e) => {
        e.preventDefault();
        playClickSound();
        if (!adForm.title || !adForm.imageUrl) {
            setMessage({ type: 'error', text: 'يرجى ملء عنوان الإعلان ورابط الصورة.' });
            return;
        }
        setLoading(true);
        setMessage('');
        try {
            const adsPath = `/artifacts/${appId}/public/data/advertisements`;
            const adData = { 
                ...adForm, 
                createdBy: userId,
                updatedAt: serverTimestamp()
            };
            if (!adForm.id) { // If new ad
                adData.createdAt = serverTimestamp();
            }

            if (adForm.id) { // Edit existing ad
                await setDoc(doc(db, adsPath, adForm.id), adData, { merge: true });
                setMessage({ type: 'success', text: 'تم تحديث الإعلان بنجاح!' });
            } else { // Add new ad
                await addDoc(collection(db, adsPath), adData);
                setMessage({ type: 'success', text: 'تم إضافة الإعلان بنجاح!' });
            }
            setAdForm({ id: null, title: '', imageUrl: '', linkUrl: '', isActive: true });
        } catch (error) {
            console.error("Error saving ad:", error);
            setMessage({ type: 'error', text: 'خطأ في حفظ الإعلان: ' + error.message });
        } finally {
            setLoading(false);
        }
    };

    const handleEditAd = (ad) => {
        playClickSound();
        setAdForm(ad);
    };

    const handleDeleteAd = async (adId) => {
        playClickSound();
         if (window.confirm('هل أنت متأكد أنك تريد حذف هذا الإعلان؟ لا يمكن التراجع عن هذا الإجراء.')) {
            setLoading(true);
            try {
                const adDocPath = `/artifacts/${appId}/public/data/advertisements/${adId}`;
                await deleteDoc(doc(db, adDocPath));
                setMessage({ type: 'success', text: 'تم حذف الإعلان بنجاح.' });
            } catch (error) {
                console.error("Error deleting ad:", error);
                setMessage({ type: 'error', text: 'خطأ في حذف الإعلان: ' + error.message });
            } finally {
                setLoading(false);
            }
        }
    };
    
    const AdminInputField = ({ id, label, type, value, onChange, checked, placeholder, step }) => (
        <div className="mb-4">
            <label htmlFor={id} className="block text-sm font-medium text-gray-300 mb-1">{label}</label>
            {type === 'checkbox' ? (
                <input id={id} type={type} checked={checked} onChange={onChange} className="rounded text-red-500 focus:ring-red-400 bg-gray-600 border-gray-500 shadow-sm"/>
            ) : type === 'textarea' ? (
                 <textarea id={id} value={value} onChange={onChange} placeholder={placeholder} rows="3" className="w-full p-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-md focus:ring-red-500 focus:border-red-500 shadow-sm"></textarea>
            ) : (
                <input id={id} type={type} value={value} onChange={onChange} placeholder={placeholder} step={step} className="w-full p-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-md focus:ring-red-500 focus:border-red-500 shadow-sm"/>
            )}
        </div>
    );

    return (
        <div className="min-h-screen bg-gray-900 p-4 md:p-8 text-white">
            <div className="container mx-auto">
                <h2 className="text-3xl font-bold text-red-500 mb-8 text-center">لوحة تحكم المشرف</h2>
                
                {message && (
                    <div className={`p-3 rounded-md mb-6 text-center text-white ${message.type === 'success' ? 'bg-green-600' : 'bg-red-700'}`}>
                        {message.text}
                    </div>
                )}

                <div className="flex justify-center space-x-4 mb-8 border-b border-gray-700 pb-4">
                    {['products', 'ads', 'settings'].map(tabName => (
                        <button
                            key={tabName}
                            onClick={() => { playClickSound(); setActiveTab(tabName); setMessage(''); }}
                            className={`py-2 px-6 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105
                                ${activeTab === tabName ? 'bg-red-600 text-white shadow-lg' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                        >
                            {tabName === 'products' ? 'إدارة المنتجات' : tabName === 'ads' ? 'إدارة الإعلانات' : 'الإعدادات'}
                        </button>
                    ))}
                </div>

                {/* إدارة المنتجات */}
                {activeTab === 'products' && (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {/* نموذج إضافة/تعديل المنتج */}
                        <div className="bg-gray-800 p-6 rounded-lg shadow-xl">
                            <h3 className="text-xl font-semibold text-red-400 mb-4">{productForm.id ? 'تعديل المنتج' : 'إضافة منتج جديد'}</h3>
                            <form onSubmit={handleProductSubmit}>
                                <AdminInputField id="productName" label="اسم المنتج" type="text" value={productForm.name} onChange={e => setProductForm({...productForm, name: e.target.value})} placeholder="اسم المنتج" />
                                <AdminInputField id="productDesc" label="وصف المنتج" type="textarea" value={productForm.description} onChange={e => setProductForm({...productForm, description: e.target.value})} placeholder="وصف تفصيلي للمنتج" />
                                <AdminInputField id="productPrice" label="السعر" type="number" value={productForm.price} onChange={e => setProductForm({...productForm, price: e.target.value})} placeholder="0.00" step="0.01" />
                                <AdminInputField id="productCurrency" label="العملة" type="text" value={productForm.currency} onChange={e => setProductForm({...productForm, currency: e.target.value})} placeholder="USD, IQD, etc." />
                                <AdminInputField id="productImageUrl" label="رابط صورة المنتج" type="url" value={productForm.imageUrl} onChange={e => setProductForm({...productForm, imageUrl: e.target.value})} placeholder="https://example.com/image.jpg" />
                                <button type="submit" disabled={loading} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-4 rounded-md shadow-md transition duration-300 transform hover:scale-105 disabled:opacity-50">
                                    {loading ? 'جاري الحفظ...' : (productForm.id ? 'تحديث المنتج' : 'إضافة المنتج')}
                                </button>
                                {productForm.id && (
                                    <button type="button" onClick={() => { playClickSound(); setProductForm({ id: null, name: '', description: '', price: '', imageUrl: '', currency: 'USD' }); }} className="mt-2 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2.5 px-4 rounded-md shadow-md transition duration-300">
                                        إلغاء التعديل
                                    </button>
                                )}
                            </form>
                        </div>
                        {/* قائمة المنتجات */}
                        <div className="bg-gray-800 p-6 rounded-lg shadow-xl overflow-x-auto">
                            <h3 className="text-xl font-semibold text-red-400 mb-4">المنتجات الحالية</h3>
                            {products.length === 0 && <p className="text-gray-400">لا توجد منتجات.</p>}
                            <ul className="space-y-3">
                                {products.map(p => (
                                    <li key={p.id} className="flex justify-between items-center p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors">
                                        <div className="truncate w-2/3">
                                            <span className="font-medium text-red-300">{p.name}</span>
                                            <span className="text-sm text-gray-400 ml-2">({p.price} {p.currency})</span>
                                        </div>
                                        <div className="space-x-2 flex-shrink-0">
                                            <button onClick={() => handleEditProduct(p)} className="text-blue-400 hover:text-blue-300 p-1 rounded hover:bg-gray-500 transition-colors"><PencilIcon /></button>
                                            <button onClick={() => handleDeleteProduct(p.id)} className="text-red-400 hover:text-red-300 p-1 rounded hover:bg-gray-500 transition-colors"><TrashIcon /></button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                )}

                {/* إدارة الإعلانات */}
                {activeTab === 'ads' && (
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="bg-gray-800 p-6 rounded-lg shadow-xl">
                            <h3 className="text-xl font-semibold text-red-400 mb-4">{adForm.id ? 'تعديل الإعلان' : 'إضافة إعلان جديد'}</h3>
                            <form onSubmit={handleAdSubmit}>
                                <AdminInputField id="adTitle" label="عنوان الإعلان" type="text" value={adForm.title} onChange={e => setAdForm({...adForm, title: e.target.value})} placeholder="عنوان جذاب للإعلان" />
                                <AdminInputField id="adImageUrl" label="رابط صورة الإعلان" type="url" value={adForm.imageUrl} onChange={e => setAdForm({...adForm, imageUrl: e.target.value})} placeholder="https://example.com/ad_image.jpg" />
                                <AdminInputField id="adLinkUrl" label="رابط توجيه الإعلان (اختياري)" type="url" value={adForm.linkUrl} onChange={e => setAdForm({...adForm, linkUrl: e.target.value})} placeholder="https://example.com/target_page" />
                                <div className="mb-4">
                                    <label htmlFor="adIsActive" className="flex items-center text-sm font-medium text-gray-300">
                                        <input id="adIsActive" type="checkbox" checked={adForm.isActive} onChange={e => setAdForm({...adForm, isActive: e.target.checked})} className="rounded text-red-500 focus:ring-red-400 bg-gray-600 border-gray-500 shadow-sm mr-2"/>
                                        تفعيل الإعلان
                                    </label>
                                </div>
                                <button type="submit" disabled={loading} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-4 rounded-md shadow-md transition duration-300 transform hover:scale-105 disabled:opacity-50">
                                    {loading ? 'جاري الحفظ...' : (adForm.id ? 'تحديث الإعلان' : 'إضافة الإعلان')}
                                </button>
                                 {adForm.id && (
                                    <button type="button" onClick={() => { playClickSound(); setAdForm({ id: null, title: '', imageUrl: '', linkUrl: '', isActive: true }); }} className="mt-2 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2.5 px-4 rounded-md shadow-md transition duration-300">
                                        إلغاء التعديل
                                    </button>
                                )}
                            </form>
                        </div>
                        <div className="bg-gray-800 p-6 rounded-lg shadow-xl overflow-x-auto">
                            <h3 className="text-xl font-semibold text-red-400 mb-4">الإعلانات الحالية</h3>
                            {ads.length === 0 && <p className="text-gray-400">لا توجد إعلانات.</p>}
                            <ul className="space-y-3">
                                {ads.map(ad => (
                                    <li key={ad.id} className="flex justify-between items-center p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors">
                                        <div className="truncate w-2/3">
                                            <span className={`font-medium ${ad.isActive ? 'text-green-400' : 'text-gray-500'}`}>{ad.title}</span>
                                            <span className="text-sm text-gray-400 ml-2">{ad.isActive ? '(نشط)' : '(غير نشط)'}</span>
                                        </div>
                                        <div className="space-x-2 flex-shrink-0">
                                            <button onClick={() => handleEditAd(ad)} className="text-blue-400 hover:text-blue-300 p-1 rounded hover:bg-gray-500 transition-colors"><PencilIcon /></button>
                                            <button onClick={() => handleDeleteAd(ad.id)} className="text-red-400 hover:text-red-300 p-1 rounded hover:bg-gray-500 transition-colors"><TrashIcon /></button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                )}
                
                {/* إعدادات الموقع (مثال: تغيير موسيقى النقر) */}
                {activeTab === 'settings' && (
                    <div className="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md mx-auto">
                        <h3 className="text-xl font-semibold text-red-400 mb-6">إعدادات الموقع</h3>
                        <p className="text-gray-400 mb-4">
                            هنا يمكنك تغيير بعض إعدادات الموقع العامة.
                            حالياً، موسيقى النقر هي صوت بسيط مدمج.
                            في المستقبل، يمكن إضافة خيار لتغيير رابط ملف صوتي مخصص.
                        </p>
                        <AdminInputField 
                            id="clickSoundUrl" 
                            label="رابط ملف موسيقى النقر (مستقبلي)" 
                            type="url" 
                            value={""} // قيمة افتراضية، لا يتم استخدامها حاليًا
                            onChange={() => {}} // وظيفة فارغة، لا يتم استخدامها حاليًا
                            placeholder="https://example.com/click-sound.mp3" 
                        />
                        <button 
                            disabled 
                            className="w-full bg-red-600 text-white font-bold py-2.5 px-4 rounded-md shadow-md opacity-50 cursor-not-allowed"
                        >
                            حفظ الإعدادات (غير مفعل حالياً)
                        </button>
                         <p className="text-xs text-gray-500 mt-2">
                            ملاحظة: تغيير موسيقى النقر الفعلية يتطلب تعديلات برمجية إضافية لاستخدام ملف صوتي خارجي بدلاً من `Tone.js`.
                        </p>
                    </div>
                )}
            </div>
        </div>
    );
};


// المكون الرئيسي للتطبيق
const App = () => {
    const [user, setUser] = useState(null);
    const [userData, setUserData] = useState(null);
    const [isAdmin, setIsAdmin] = useState(false);
    const [currentPage, setCurrentPage] = useState('home'); // home, login, admin, profile
    const [loadingAuth, setLoadingAuth] = useState(true);
    const [isAuthReady, setIsAuthReady] = useState(false); // لتتبع اكتمال onAuthStateChanged الأولي

    const currentUserIdRef = useRef(null); // لتخزين userId الحالي وتجنب إعادة إنشاء onSnapshot

    // تهيئة Firebase والمصادقة
    useEffect(() => {
        const initFirebase = async () => {
            try {
                // setLogLevel('debug'); // لتمكين تسجيلات Firestore التفصيلية
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    // إذا لم يكن هناك توكن مخصص، يمكن تسجيل الدخول كمجهول أو ترك المستخدم يسجل دخوله يدويًا
                    // await signInAnonymously(auth);
                    // console.log("Signed in anonymously as no custom token was provided.");
                    // أو لا تفعل شيئًا ودع المستخدم يسجل الدخول عبر الواجهة
                     console.log("No custom token provided. User needs to log in manually.");
                }
            } catch (error) {
                console.error("Firebase Auth initialization error:", error);
                // إذا فشل signInWithCustomToken، حاول signInAnonymously كبديل إذا كان ذلك مناسبًا
                // try {
                //     await signInAnonymously(auth);
                //     console.log("Fell back to anonymous sign-in.");
                // } catch (anonError) {
                //     console.error("Anonymous sign-in fallback error:", anonError);
                // }
            }
        };
        initFirebase();

        const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
            setUser(currentUser);
            currentUserIdRef.current = currentUser ? currentUser.uid : null;
            if (currentUser) {
                // لا تقم بجلب بيانات المستخدم هنا مباشرة، دع useEffect التالي يتعامل معها
            } else {
                setUserData(null);
                setIsAdmin(false);
            }
            setLoadingAuth(false);
            setIsAuthReady(true); // المصادقة جاهزة
            if (!currentUser && currentPage !== 'login') { // إذا لم يكن هناك مستخدم، اذهب لصفحة الدخول
                 setCurrentPage('login');
            } else if (currentUser && currentPage === 'login') {
                 setCurrentPage('home'); // إذا سجل الدخول وهو في صفحة الدخول، اذهب للرئيسية
            }
        });
        return () => unsubscribeAuth();
    }, []);

    // جلب بيانات المستخدم وتحديثها عند تغيير المستخدم أو حالة المصادقة
    useEffect(() => {
        let unsubscribeUserData = () => {};

        if (isAuthReady && user && user.uid) { // تأكد من أن المصادقة جاهزة وأن هناك مستخدم
            setLoadingAuth(true); // إظهار التحميل أثناء جلب بيانات المستخدم
            const userDocPath = `/artifacts/${appId}/users/${user.uid}`;
            const userDocRef = doc(db, userDocPath);
            
            unsubscribeUserData = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    setUserData(data);
                    setIsAdmin(data.isAdmin === true); // تحقق من صلاحيات المشرف
                    if (data.isAdmin === true && currentPage === 'login') { // إذا كان مشرفًا وسجل الدخول للتو
                        setCurrentPage('admin'); // اذهب إلى لوحة التحكم
                    } else if (currentPage === 'login') { // إذا كان مستخدمًا عاديًا وسجل الدخول للتو
                        setCurrentPage('home');
                    }
                } else {
                    // هذا يمكن أن يحدث إذا تم حذف مستند المستخدم أو لم يتم إنشاؤه بعد
                    console.warn("User document does not exist for UID:", user.uid);
                    // يمكنك هنا محاولة إنشاء مستند افتراضي إذا لم يكن موجودًا، أو تسجيل الخروج
                    // signOut(auth); // مثال: تسجيل الخروج إذا لم يوجد مستند
                    setUserData(null);
                    setIsAdmin(false);
                }
                setLoadingAuth(false);
            }, (error) => {
                console.error("Error fetching user data:", error);
                setUserData(null);
                setIsAdmin(false);
                setLoadingAuth(false);
            });
        } else if (isAuthReady && !user) { // إذا كانت المصادقة جاهزة ولا يوجد مستخدم
            setUserData(null);
            setIsAdmin(false);
            setLoadingAuth(false);
            if (currentPage !== 'login') {
                 setCurrentPage('login');
            }
        }
        
        return () => unsubscribeUserData();
    }, [isAuthReady, user]); // الاعتماد على isAuthReady و user

    const handleLogout = async () => {
        playClickSound();
        try {
            await signOut(auth);
            setUser(null);
            setUserData(null);
            setIsAdmin(false);
            setCurrentPage('login');
        } catch (error) {
            console.error("Logout error", error);
        }
    };

    const handlePageChange = (page) => {
        playClickSound();
        setCurrentPage(page);
    };
    
    const handleUpdateUserData = (updatedData) => {
        setUserData(updatedData);
    };

    if (loadingAuth && !isAuthReady) { // عرض شاشة تحميل أولية حتى تتحقق المصادقة
        return <div className="flex items-center justify-center min-h-screen bg-gray-900 text-white text-xl">جاري تهيئة التطبيق...</div>;
    }


    const renderPage = () => {
        switch (currentPage) {
            case 'login':
                return <AuthPage onLoginSuccess={() => { /* setCurrentPage('home'); يتم التعامل معه في onAuthStateChanged */ }} onPageChange={handlePageChange} />;
            case 'admin':
                return isAdmin ? <AdminPage user={user} /> : <HomePage onPageChange={handlePageChange} user={user} isAdmin={isAdmin} userData={userData} />; // إذا لم يكن مشرفًا، اذهب للرئيسية
            case 'profile':
                return user ? <ProfilePage user={user} userData={userData} onPageChange={handlePageChange} onUpdateUserData={handleUpdateUserData} /> : <AuthPage onLoginSuccess={() => {/* setCurrentPage('home'); */}} onPageChange={handlePageChange} />;
            case 'home':
            default:
                return <HomePage onPageChange={handlePageChange} user={user} isAdmin={isAdmin} userData={userData} />;
        }
    };

    return (
        <div className="min-h-screen bg-gray-900 font-sans" dir="rtl">
            <Navbar user={user} onLogout={handleLogout} onPageChange={handlePageChange} isAdmin={isAdmin} userData={userData} />
            <main className="pt-0"> {/* Navbar is sticky, so no extra padding needed here unless desired */}
                {loadingAuth && isAuthReady && <div className="text-center p-4 text-white bg-red-700">جاري تحميل بيانات المستخدم...</div>}
                {!loadingAuth && renderPage()}
            </main>
            <Footer />
        </div>
    );
};

const Footer = () => (
    <footer className="bg-black text-gray-400 p-6 text-center shadow-inner mt-auto">
        <p>&copy; {new Date().getFullYear()} متجر ابو العز. جميع الحقوق محفوظة.</p>
        <p className="text-sm">تصميم وتطوير بواسطة نموذج Gemini</p>
    </footer>
);

export default App;

